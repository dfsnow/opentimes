---

stages:
  fetch_tiger_national:
    matrix:
      year: ${input.year}
      geography: ${input.census.geography.national}
    cmd: "python ./src/fetch_tiger.py
      --year ${item.year} --geography ${item.geography}"
    outs:
      - ./input/tiger/year=${item.year}/geography=${item.geography}/${item.geography}.zip:
          persist: true

  fetch_tiger_by_state:
    matrix:
      year: ${input.year}
      geography: ${input.census.geography.by_state}
      state: ${input.state}
    cmd: "python ./src/fetch_tiger.py
      --year ${item.year} --geography ${item.geography} --state ${item.state}"
    outs:
      - ./input/tiger/year=${item.year}/geography=${item.geography}/state=${item.state}/${item.state}.zip:
          persist: true

  fetch_blockpop_by_state:
    matrix:
      year:
        - '2020'
      state: ${input.state}
    cmd: >-
      python ./src/fetch_blockpop.py --year ${item.year} --state ${item.state}
    outs:
      - ./input/blockpop/year=${item.year}/state=${item.state}/${item.state}.parquet:
          persist: true

  fetch_osm_national:
    matrix:
      year: ${input.year}
    cmd:
      'LAST_TWO=$( echo ${item.year} | cut -c 3-4) &&
      mkdir -p ./input/osm/year=${item.year} &&
      wget -P ./input/osm/year=${item.year}
      -O ./input/osm/year=${item.year}/us-${item.year}.osm.pbf
      https://download.geofabrik.de/north-america-"$LAST_TWO"0101.osm.pbf'
    outs:
      - ./input/osm/year=${item.year}/us-${item.year}.osm.pbf:
          persist: true

  create_blockloc:
    deps:
      - ./input/blockpop
      - ./input/tiger
    matrix:
      year: ${input.year}
      state: ${input.state}
    cmd: "python ./src/create_blockloc.py
      --year ${item.year} --state ${item.state}"
    outs:
      - ./intermediate/blockloc/year=${item.year}/state=${item.state}/${item.state}.parquet

  # create_census_gpq:
  #   params:
  #     - input.year
  #     - input.census.geography.by_state
  #     - input.state
  #   deps:
  #     - ./input/blockpop
  #     - ./input/tiger
  #   matrix:
  #     year: ${input.year}
  #     geography:
  #       - ${input.census.geography.national}
  #       - ${input.census.geography.by_state}
  #     state: ${input.state}
  #   cmd: "python ./src/generate_census_gpq.py
  #     --year ${item.year} --geography ${item.geography} --state ${item.state}"
  #   outs:
  #     - ./intermediate/census/gpq/year=${item.year}/geography=${item.geography}/state=${item.state}/${item.state}.parquet
